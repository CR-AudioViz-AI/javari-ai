# ============================================================================
# MASS SECURITY VULNERABILITY FIX WORKFLOW
# ============================================================================
# Purpose: Fix npm audit vulnerabilities across all repositories
# Trigger: Manual workflow dispatch
# Created: 2026-01-29
# ============================================================================

name: Fix Security Vulnerabilities

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Repositories to fix (comma-separated, or "all")'
        required: true
        default: 'all'

jobs:
  fix-vulnerabilities:
    name: Fix ${{ matrix.repo }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        repo:
          # Core Platform
          - javari-ai
          - javari-components
          - crav-auth
          - javari-scraper
          
          # Universe Modules
          - javari-social-posts
          - javari-sports-cards-pro
          - javari-stamp-stack
          - javari-star-wars-stash
          - javari-sustainability
          - javari-transportation
          - javari-veterans-connect
          - javari-vinyl-vault
          - javari-watch-works
          - javari-weddings
          - javari-whiskey-warehouse
          - javari-wine-cellar
          - javariverse
          - strategic-command
          
          # Manual Fix Required
          - knitting-platform
          - machineknit-platform
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: CR-AudioViz-AI/${{ matrix.repo }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Check for package.json
        id: check-package
        run: |
          if [ -f "package.json" ]; then
            echo "has_package=true" >> $GITHUB_OUTPUT
          else
            echo "has_package=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No package.json found - skipping"
          fi
      
      - name: Install dependencies
        if: steps.check-package.outputs.has_package == 'true'
        run: npm ci || npm install
      
      - name: Run npm audit fix
        if: steps.check-package.outputs.has_package == 'true'
        id: audit-fix
        run: |
          echo "Running npm audit fix --force..."
          npm audit fix --force > audit-output.txt 2>&1 || true
          
          # Check if anything changed
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ“ No vulnerabilities found or already fixed"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ Vulnerabilities fixed"
            cat audit-output.txt
          fi
      
      - name: Create Pull Request
        if: steps.check-package.outputs.has_package == 'true' && steps.audit-fix.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            security: fix npm audit vulnerabilities (automated)
            
            - Ran npm audit fix --force
            - Updated vulnerable dependencies
            - Preview branch for review before production
            - Executed: ${{ github.run_id }}
          branch: security/npm-audit-fix-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ”’ Security: Fix npm audit vulnerabilities'
          body: |
            ## Security Vulnerability Fix
            
            **Automated fix via GitHub Actions**
            
            ### What This Does
            - Ran `npm audit fix --force`
            - Updated vulnerable dependencies to patched versions
            - All changes are in preview branch
            
            ### Review Checklist
            - [ ] Check Vercel preview deployment
            - [ ] Verify app still builds
            - [ ] Test critical functionality
            - [ ] Review package.json changes
            
            ### Audit Output
            ```
            See workflow logs for full npm audit output
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ```
            
            ### Next Steps
            1. Review Vercel preview deployment
            2. Test the preview
            3. Merge when satisfied
            4. Auto-deploys to production
            
            ---
            
            **Generated:** ${{ github.event.repository.updated_at }}  
            **Workflow:** security-fix-workflow.yml  
            **Repository:** ${{ matrix.repo }}
          labels: |
            security
            dependencies
            automated
          assignees: roy-henderson
          draft: false
      
      - name: Summary
        if: always()
        run: |
          echo "## Security Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ matrix.repo }}" >> $GITHUB_STEP_SUMMARY
          echo "**Has package.json:** ${{ steps.check-package.outputs.has_package }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes made:** ${{ steps.audit-fix.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.audit-fix.outputs.changed }}" = "true" ]; then
            echo "âœ… **Pull request created**" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **No changes needed**" >> $GITHUB_STEP_SUMMARY
          fi
